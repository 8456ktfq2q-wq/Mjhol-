<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Ù…Ø¬Ù‡ÙˆÙ„+</title>

  <!-- âœ… PWA (Ù…Ù„Ù ÙˆØ§Ø­Ø¯ PNG) -->
  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="theme-color" content="#7c3aed" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Ù…Ø¬Ù‡ÙˆÙ„+">
  <link rel="apple-touch-icon" href="/icon.png">

  <!-- Socket.io -->
  <script src="/socket.io/socket.io.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#06040f; --bg2:#0b0720;
      --card:rgba(255,255,255,.06); --card2:rgba(255,255,255,.09);
      --text:#f3f2ff; --muted:#a7a3c7;
      --p:#7c3aed; --p2:#a78bfa; --g:#22c55e; --r:#ef4444; --c:#06b6d4;
      --shadow: 0 18px 60px rgba(0,0,0,.45);
    }
    [data-theme="light"]{
      --bg:#f6f5ff; --bg2:#eeeaff;
      --card:rgba(0,0,0,.05); --card2:rgba(0,0,0,.08);
      --text:#1b1734; --muted:#5b567a;
      --shadow: 0 18px 60px rgba(0,0,0,.12);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      font-family:'Tajawal',system-ui,-apple-system,Segoe UI,Arial;
      background: radial-gradient(1200px 700px at 20% -10%, rgba(124,58,237,.35), transparent 60%),
                  radial-gradient(900px 600px at 90% 0%, rgba(6,182,212,.18), transparent 60%),
                  linear-gradient(180deg,var(--bg2),var(--bg));
      color:var(--text);
      overflow:hidden;
    }

    /* Ø®Ù„ÙÙŠØ© Ù†Ø¬ÙˆÙ… */
    #stars{position:fixed;inset:0;z-index:0;opacity:.8}
    [data-theme="light"] #stars{opacity:.15}

    .grain{
      position:fixed;inset:0;z-index:1;pointer-events:none;opacity:.03;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='260' height='260'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='260' height='260' filter='url(%23n)'/%3E%3C/svg%3E");
      animation: g 0.55s steps(2) infinite;
    }
    @keyframes g{0%{transform:translate(0,0)}25%{transform:translate(-2px,2px)}50%{transform:translate(2px,-2px)}75%{transform:translate(-2px,-1px)}100%{transform:translate(2px,2px)}}

    .app{
      position:relative;z-index:2;height:100%;
      display:flex;flex-direction:column;
    }

    /* Ø²Ø± Ø§Ù„Ø«ÙŠÙ… */
    .theme-btn{
      position:fixed;top:12px;left:12px;z-index:50;
      width:44px;height:44px;border-radius:999px;
      border:1px solid var(--card2);background:var(--card);
      color:var(--text);display:flex;align-items:center;justify-content:center;
      backdrop-filter: blur(16px);
      cursor:pointer;box-shadow:var(--shadow);
    }

    /* Ø´Ø§Ø´Ø§Øª */
    .screen{display:none;height:100%}
    .screen.active{display:flex}

    /* Landing */
    #landing{align-items:center;justify-content:center;padding:24px;text-align:center}
    .hero{
      width:min(560px,100%);
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border:1px solid var(--card2);
      border-radius:28px;
      padding:26px 20px;
      box-shadow:var(--shadow);
      backdrop-filter: blur(18px);
    }
    [data-theme="light"] .hero{
      background:linear-gradient(180deg, rgba(0,0,0,.04), rgba(0,0,0,.02));
    }
    .logo{
      width:92px;height:92px;margin:0 auto 16px;border-radius:28px;
      background: radial-gradient(circle at 30% 20%, rgba(167,139,250,.9), rgba(124,58,237,.9));
      box-shadow: 0 20px 60px rgba(124,58,237,.35);
      display:flex;align-items:center;justify-content:center;
      position:relative;
      overflow:hidden;
    }
    .logo::after{
      content:"";
      position:absolute;inset:-30%;
      background:conic-gradient(from 90deg, rgba(255,255,255,.0), rgba(255,255,255,.35), rgba(255,255,255,.0));
      animation: sweep 2.8s linear infinite;
    }
    @keyframes sweep{to{transform:rotate(360deg)}}
    .logo span{
      position:relative;z-index:1;
      font-size:34px;
    }
    .title{
      font-size: clamp(46px, 11vw, 76px);
      line-height:1;
      font-weight:900;
      letter-spacing:-.03em;
      background: linear-gradient(135deg, #fff 0%, var(--p2) 45%, var(--c) 100%);
      -webkit-background-clip:text;background-clip:text;color:transparent;
      margin-bottom:10px;
    }
    [data-theme="light"] .title{
      background: linear-gradient(135deg, #2b165f 0%, var(--p) 45%, #0e7490 100%);
      -webkit-background-clip:text;background-clip:text;color:transparent;
    }
    .sub{color:var(--muted);font-weight:400;margin-bottom:18px}
    .stats{display:flex;gap:18px;justify-content:center;margin:10px 0 18px}
    .stat{
      min-width:110px;
      padding:10px 12px;border-radius:16px;
      background:var(--card);border:1px solid var(--card2);
    }
    .stat b{display:block;font-size:20px;font-weight:900;color:var(--p2)}
    .stat small{color:var(--muted)}
    .tags{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin:8px 0 18px}
    .tag{
      padding:10px 14px;border-radius:999px;
      background:var(--card);border:1px solid var(--card2);
      color:var(--muted);cursor:pointer;user-select:none;
      transition:.15s transform,.15s border-color,.15s color,.15s background;
    }
    .tag.active{border-color:rgba(167,139,250,.7);color:var(--text);background:rgba(124,58,237,.18)}
    .tag:active{transform:scale(.98)}

    .cta{
      display:flex;flex-direction:column;gap:12px;align-items:center;
      margin-top:8px;
    }
    .btn{
      width:min(420px,100%);
      padding:16px 18px;border:none;border-radius:999px;
      font-weight:900;font-size:18px;color:#fff;cursor:pointer;
      background:linear-gradient(135deg,var(--p),#9333ea,var(--p2));
      box-shadow: 0 14px 44px rgba(124,58,237,.35);
      display:flex;align-items:center;justify-content:center;gap:10px;
      transition:.2s transform,.2s box-shadow;
    }
    .btn:hover{transform:translateY(-2px);box-shadow:0 22px 60px rgba(124,58,237,.45)}
    .btn:active{transform:scale(.98)}
    .pill{
      font-size:13px;color:var(--muted);
      display:flex;align-items:center;gap:8px;
    }

    /* Matching */
    #matching{align-items:center;justify-content:center;flex-direction:column;gap:16px}
    .ring{
      width:180px;height:180px;border-radius:999px;position:relative;
      border:1px solid rgba(167,139,250,.25);
      display:flex;align-items:center;justify-content:center;
    }
    .ring::before{
      content:"";position:absolute;inset:-14px;border-radius:999px;
      border:1px solid rgba(167,139,250,.18);
      animation: pulse 1.8s ease-in-out infinite;
    }
    .ring::after{
      content:"";position:absolute;inset:0;border-radius:999px;
      background:conic-gradient(from 0deg, transparent 70%, rgba(124,58,237,.6));
      animation: rot 1.2s linear infinite;
    }
    @keyframes rot{to{transform:rotate(360deg)}}
    @keyframes pulse{50%{transform:scale(1.05);opacity:.5}}
    .ring .ic{
      width:54px;height:54px;border-radius:999px;
      background:linear-gradient(135deg,var(--p),var(--p2));
      display:flex;align-items:center;justify-content:center;
      z-index:1;font-size:22px;
      box-shadow:0 18px 50px rgba(124,58,237,.35);
    }
    .matchT{font-size:24px;font-weight:900}
    .matchS{color:var(--muted)}
    .btn2{
      padding:12px 18px;border-radius:999px;border:1px solid var(--card2);
      background:var(--card);color:var(--muted);cursor:pointer;
    }

    /* Chat */
    #chat{flex-direction:column;height:100%}
    .top{
      display:flex;align-items:center;justify-content:space-between;
      padding:14px 14px calc(14px + env(safe-area-inset-top));
      background:rgba(10,7,25,.75);
      border-bottom:1px solid var(--card2);
      backdrop-filter: blur(18px);
    }
    [data-theme="light"] .top{background:rgba(246,245,255,.88)}
    .peer{
      display:flex;gap:10px;align-items:center;
    }
    .ava{
      width:44px;height:44px;border-radius:999px;
      background:linear-gradient(135deg,var(--p),var(--p2));
      display:flex;align-items:center;justify-content:center;
      position:relative;
    }
    .dot{
      position:absolute;bottom:2px;right:2px;
      width:10px;height:10px;border-radius:999px;background:var(--g);
      border:2px solid rgba(10,7,25,.75);
    }
    [data-theme="light"] .dot{border-color:rgba(246,245,255,.88)}
    .pname{font-weight:900}
    .pmeta{font-size:12px;color:var(--muted);margin-top:2px}
    .actions{display:flex;gap:8px}
    .iconBtn{
      width:38px;height:38px;border-radius:999px;
      border:1px solid var(--card2);background:var(--card);
      color:var(--text);cursor:pointer;
    }

    .msgs{
      flex:1;overflow:auto;padding:16px 14px;
      background:linear-gradient(180deg, rgba(255,255,255,.03), transparent);
    }
    .sys{
      width:fit-content;max-width:92%;
      margin:10px auto;
      padding:8px 12px;border-radius:999px;
      border:1px solid var(--card2);background:var(--card);
      color:var(--muted);font-size:12px;
    }
    .row{display:flex;gap:8px;margin:10px 0;max-width:92%}
    .row.me{margin-left:auto;flex-direction:row-reverse}
    .bub{
      padding:12px 14px;border-radius:18px;line-height:1.7;
      border:1px solid var(--card2);
      background:rgba(255,255,255,.05);
      white-space:pre-wrap;
    }
    .me .bub{
      background:linear-gradient(135deg,var(--p),#9333ea);
      border:none;color:#fff;
      box-shadow:0 14px 40px rgba(124,58,237,.28);
    }
    .time{font-size:11px;color:var(--muted);margin-top:4px}

    .typing{
      display:none;gap:8px;align-items:center;
      padding:8px 14px;color:var(--muted);font-size:12px;
    }
    .typing.show{display:flex}
    .dots{display:flex;gap:4px}
    .dots i{
      width:6px;height:6px;border-radius:999px;background:var(--muted);
      animation: d 1.2s infinite ease-in-out;
    }
    .dots i:nth-child(2){animation-delay:.15s}
    .dots i:nth-child(3){animation-delay:.3s}
    @keyframes d{50%{transform:translateY(-3px);opacity:.4}}

    .bottom{
      padding:12px 12px calc(12px + env(safe-area-inset-bottom));
      border-top:1px solid var(--card2);
      background:rgba(10,7,25,.78);
      backdrop-filter: blur(18px);
    }
    [data-theme="light"] .bottom{background:rgba(246,245,255,.92)}
    .inrow{display:flex;gap:10px;align-items:flex-end}
    textarea{
      flex:1;min-height:44px;max-height:120px;resize:none;
      border-radius:18px;border:1px solid var(--card2);
      background:var(--card);color:var(--text);
      padding:10px 12px;outline:none;
      font-family:inherit;line-height:1.6;
    }
    .send{
      width:44px;height:44px;border-radius:999px;border:none;
      background:linear-gradient(135deg,var(--p),var(--p2));
      color:#fff;font-size:18px;cursor:pointer;
      box-shadow:0 12px 34px rgba(124,58,237,.35);
    }
    .mic{
      width:44px;height:44px;border-radius:999px;border:1px solid var(--card2);
      background:var(--card);color:var(--text);cursor:pointer;
      display:flex;align-items:center;justify-content:center;
    }
    .mic.rec{
      border-color:rgba(239,68,68,.55);
      box-shadow:0 0 0 4px rgba(239,68,68,.15);
      color:#fff;
      background:linear-gradient(135deg,#ef4444,#f97316);
    }
    .hint{
      margin-top:8px;display:flex;justify-content:space-between;gap:10px;
      color:var(--muted);font-size:12px;padding:0 2px;
    }

    .toastArea{
      position:fixed;top:12px;left:50%;transform:translateX(-50%);
      z-index:999;display:flex;flex-direction:column;gap:8px;pointer-events:none;
    }
    .toast{
      pointer-events:none;
      padding:10px 14px;border-radius:999px;
      border:1px solid var(--card2);background:rgba(10,7,25,.88);
      backdrop-filter: blur(18px);
      color:var(--text);font-size:13px;
      box-shadow:var(--shadow);
      animation: tin .25s ease both;
    }
    [data-theme="light"] .toast{background:rgba(246,245,255,.92)}
    @keyframes tin{from{opacity:0;transform:translateY(-8px)}to{opacity:1;transform:translateY(0)}}
    .toast.out{animation:tout .22s ease both}
    @keyframes tout{to{opacity:0;transform:translateY(-8px)}}

    /* Ø²Ø± ØªØ«Ø¨ÙŠØª */
    #installBtn{display:none}
    #installBtn.show{display:inline-flex}

    /* Ø£Ø²Ø±Ø§Ø± ØµØºÙŠØ±Ø© */
    .miniBtns{display:flex;gap:8px;flex-wrap:wrap}
    .mini{
      padding:8px 10px;border-radius:999px;border:1px solid var(--card2);
      background:var(--card);color:var(--muted);cursor:pointer;font-size:12px;
    }
  </style>
</head>

<body>
  <canvas id="stars"></canvas>
  <div class="grain"></div>

  <button class="theme-btn" id="themeBtn" title="ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø³Ù…Ø©">ğŸŒ™</button>
  <div class="toastArea" id="toasts"></div>

  <div class="app">
    <!-- Landing -->
    <section class="screen active" id="landing">
      <div class="hero">
        <div class="logo"><span>ğŸ‘¤</span></div>
        <div class="title">Ù…Ø¬Ù‡ÙˆÙ„+</div>
        <div class="sub">Ø¯Ø±Ø¯Ø´ Ù…Ø¹ ØºØ±ÙŠØ¨ â€” Ø¨Ù„Ø§ Ù‡ÙˆÙŠØ©ØŒ Ø¨Ù„Ø§ Ù‚ÙŠÙˆØ¯</div>

        <div class="stats">
          <div class="stat"><b id="onlineNow">â€”</b><small>Ù…ØªØµÙ„ Ø§Ù„Ø¢Ù†</small></div>
          <div class="stat"><b id="chattingNow">â€”</b><small>ÙÙŠ Ø¯Ø±Ø¯Ø´Ø©</small></div>
          <div class="stat"><b>âˆ</b><small>Ù„Ø§ Ø­Ø¯ÙˆØ¯</small></div>
        </div>

        <div class="tags" id="tags">
          <div class="tag">ğŸ® Ø£Ù„Ø¹Ø§Ø¨</div>
          <div class="tag">ğŸµ Ù…ÙˆØ³ÙŠÙ‚Ù‰</div>
          <div class="tag">ğŸ“š ÙƒØªØ¨</div>
          <div class="tag">ğŸ¬ Ø£ÙÙ„Ø§Ù…</div>
          <div class="tag">ğŸ’» ØªÙ‚Ù†ÙŠØ©</div>
          <div class="tag">âš½ Ø±ÙŠØ§Ø¶Ø©</div>
          <div class="tag">ğŸ¨ ÙÙ†</div>
          <div class="tag">âœˆï¸ Ø³ÙØ±</div>
          <div class="tag">ğŸ• Ø·Ø¹Ø§Ù…</div>
          <div class="tag">ğŸ§  ÙÙ„Ø³ÙØ©</div>
        </div>

        <div class="cta">
          <button class="btn" id="startBtn">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© â†</button>

          <div class="miniBtns">
            <button class="mini" id="installBtn">ğŸ“² ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</button>
            <button class="mini" id="shareBtn">ğŸ”— Ù…Ø´Ø§Ø±ÙƒØ©</button>
          </div>

          <div class="pill">ğŸ”’ Ù„Ø§ ØªØ³Ø¬ÙŠÙ„ Â· Ù„Ø§ Ø¨ÙŠØ§Ù†Ø§Øª Â· Ù…Ø¬Ù‡ÙˆÙ„ ØªÙ…Ø§Ù…Ø§Ù‹</div>
        </div>
      </div>
    </section>

    <!-- Matching -->
    <section class="screen" id="matching">
      <div class="ring"><div class="ic">ğŸ‘¤</div></div>
      <div class="matchT">Ù†Ø¨Ø­Ø« Ù„Ùƒ...</div>
      <div class="matchS" id="matchSub">Ø¬Ø§Ø±ÙŠ Ù…Ø³Ø­ Ø§Ù„Ø´Ø¨ÙƒØ©</div>
      <button class="btn2" id="cancelBtn">Ø¥Ù„ØºØ§Ø¡</button>
    </section>

    <!-- Chat -->
    <section class="screen" id="chat">
      <div class="top">
        <div class="peer">
          <div class="ava"><span id="peerEmoji">ğŸ‘¤</span><span class="dot" id="peerDot"></span></div>
          <div>
            <div class="pname">Ù…Ø¬Ù‡ÙˆÙ„ <span style="color:var(--p2)" id="peerId">#0000</span></div>
            <div class="pmeta" id="peerStat">âš¡ Ù…ØªØµÙ„ Ø§Ù„Ø¢Ù†</div>
          </div>
        </div>
        <div class="actions">
          <button class="iconBtn" id="nextBtn" title="Ø´Ø®Øµ Ø¬Ø¯ÙŠØ¯">ğŸ”€</button>
          <button class="iconBtn" id="endBtn" title="Ø¥Ù†Ù‡Ø§Ø¡">âœ•</button>
        </div>
      </div>

      <div class="msgs" id="msgs">
        <div class="sys">ğŸ”’ Ù…Ø­Ø§Ø¯Ø«Ø© Ø®Ø§ØµØ© Â· Ù„Ø§ Ø£Ø­Ø¯ ÙŠØ±Ø§Ù‡Ø§</div>
      </div>

      <div class="typing" id="typing">
        <div class="dots"><i></i><i></i><i></i></div>
        <span>Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙƒØªØ§Ø¨Ø©...</span>
      </div>

      <div class="bottom">
        <div class="inrow">
          <button class="mic" id="micBtn" title="ØªØ³Ø¬ÙŠÙ„ ØµÙˆØª">ğŸ™ï¸</button>
          <textarea id="input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ..." rows="1"></textarea>
          <button class="send" id="sendBtn" title="Ø¥Ø±Ø³Ø§Ù„">â¤</button>
        </div>
        <div class="hint">
          <span id="count">0 / 500</span>
          <span id="conn">ğŸŸ¡ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...</span>
        </div>
      </div>
    </section>
  </div>

<script>
/* =========================
   â­ Stars
========================= */
const cvs = document.getElementById('stars');
const ctx = cvs.getContext('2d');
let stars = [];
function resize(){
  cvs.width = innerWidth; cvs.height = innerHeight;
  stars = Array.from({length: 120}, () => ({
    x: Math.random()*cvs.width,
    y: Math.random()*cvs.height,
    r: Math.random()*1.1 + .2,
    a: Math.random()*Math.PI*2,
    s: Math.random()*.003 + .001,
    dx: (Math.random()-.5)*.05
  }));
}
function draw(){
  ctx.clearRect(0,0,cvs.width,cvs.height);
  for(const p of stars){
    p.a += p.s;
    p.x += p.dx;
    if(p.x < 0) p.x = cvs.width;
    if(p.x > cvs.width) p.x = 0;
    const al = (Math.sin(p.a)+1)/2*.55 + .08;
    ctx.beginPath();
    ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
    ctx.fillStyle = `rgba(167,139,250,${al})`;
    ctx.fill();
  }
  requestAnimationFrame(draw);
}
resize(); draw();
addEventListener('resize', resize);

/* =========================
   Helpers
========================= */
const $ = (id)=>document.getElementById(id);
function show(id){
  for(const s of document.querySelectorAll('.screen')) s.classList.remove('active');
  $(id).classList.add('active');
}
function toast(msg, dur=2500){
  const area = $('toasts');
  const t = document.createElement('div');
  t.className = 'toast';
  t.textContent = msg;
  area.appendChild(t);
  setTimeout(()=>{ t.classList.add('out'); setTimeout(()=>t.remove(),250); }, dur);
}
function timeNow(){
  return new Date().toLocaleTimeString('ar-SA',{hour:'2-digit',minute:'2-digit'});
}
function getTags(){
  return [...document.querySelectorAll('#tags .tag.active')].map(x=>x.textContent.trim());
}

/* =========================
   Theme
========================= */
let theme = localStorage.getItem('mjTheme') || 'dark';
function applyTheme(){
  document.documentElement.setAttribute('data-theme', theme==='light' ? 'light' : '');
  $('themeBtn').textContent = theme==='light' ? 'ğŸŒ™' : 'â˜€ï¸';
  localStorage.setItem('mjTheme', theme);
}
$('themeBtn').onclick = ()=>{
  theme = theme==='dark' ? 'light' : 'dark';
  applyTheme();
  toast(theme==='light' ? 'â˜€ï¸ ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙØ§ØªØ­' : 'ğŸŒ™ ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¯Ø§ÙƒÙ†');
};
applyTheme();

/* =========================
   PWA: Service Worker + Install
========================= */
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js').catch(()=>{});
}
let deferredPrompt = null;
window.addEventListener('beforeinstallprompt', (e)=>{
  e.preventDefault();
  deferredPrompt = e;
  $('installBtn').classList.add('show');
});
$('installBtn').onclick = async ()=>{
  if(!deferredPrompt) return toast('â— Ø§Ù„ØªØ«Ø¨ÙŠØª ØºÙŠØ± Ù…ØªØ§Ø­ Ø§Ù„Ø¢Ù†');
  deferredPrompt.prompt();
  await deferredPrompt.userChoice;
  deferredPrompt = null;
  $('installBtn').classList.remove('show');
};
$('shareBtn').onclick = async ()=>{
  const url = location.href;
  if(navigator.share){
    try{ await navigator.share({title:'Ù…Ø¬Ù‡ÙˆÙ„+', text:'Ø¬Ø±Ù‘Ø¨ Ù…Ø¬Ù‡ÙˆÙ„+', url}); }catch(e){}
  }else{
    try{ await navigator.clipboard.writeText(url); toast('âœ… ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·'); }catch(e){ toast(url, 4000); }
  }
};

/* =========================
   Tags UI
========================= */
for(const el of document.querySelectorAll('#tags .tag')){
  el.addEventListener('click', ()=> el.classList.toggle('active'));
}

/* =========================
   Socket.IO
========================= */
const socket = io({
  transports: ['websocket','polling'],  // âœ… ÙŠÙ…Ù†Ø¹ Transport unknown
  upgrade: true,
  reconnectionAttempts: 8,
  reconnectionDelay: 1500
});

socket.on('connect', ()=>{
  $('conn').textContent = 'ğŸŸ¢ Ù…ØªØµÙ„';
  fetchStats();
});
socket.on('disconnect', ()=>{
  $('conn').textContent = 'ğŸ”´ Ø§Ù†Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„';
});
socket.on('connect_error', ()=>{
  $('conn').textContent = 'ğŸŸ¡ Ù…Ø´ÙƒÙ„Ø© Ø§ØªØµØ§Ù„';
});

/* Stats */
socket.on('stats:update', (d)=>{
  $('onlineNow').textContent = d.online ?? 0;
  $('chattingNow').textContent = d.chatting ?? 0;
});
async function fetchStats(){
  try{
    const r = await fetch('/api/stats', {cache:'no-store'});
    const d = await r.json();
    $('onlineNow').textContent = d.online ?? 0;
    $('chattingNow').textContent = d.chatting ?? 0;
  }catch(e){}
}

/* Matching */
socket.on('waiting', ()=>{
  $('matchSub').textContent = 'ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±... â³';
});
socket.on('matched', ({peerId})=>{
  connectChat(peerId);
});

/* Text messages */
socket.on('message:receive', ({text})=>{
  addMsg('them', text);
});

/* Voice messages (Blob/ArrayBuffer) */
socket.on('voice:receive', async ({audio, mime})=>{
  // audio Ù‚Ø¯ ÙŠØµÙ„ ArrayBuffer Ø£Ùˆ base64 Ø­Ø³Ø¨ Ø³ÙŠØ±ÙØ±Ùƒ
  let blob;
  if (audio instanceof ArrayBuffer) {
    blob = new Blob([audio], {type: mime || 'audio/webm'});
  } else if (typeof audio === 'string') {
    // base64
    const bin = atob(audio);
    const bytes = new Uint8Array(bin.length);
    for (let i=0;i<bin.length;i++) bytes[i] = bin.charCodeAt(i);
    blob = new Blob([bytes], {type: mime || 'audio/webm'});
  } else {
    return;
  }
  addVoice('them', blob);
});

/* Typing */
let typingTimer=null;
socket.on('typing:start', ()=> $('typing').classList.add('show'));
socket.on('typing:stop', ()=> $('typing').classList.remove('show'));

/* Partner left */
socket.on('partner:left', ()=>{
  $('peerStat').textContent = 'ØºÙŠØ± Ù…ØªØµÙ„';
  $('peerDot').style.background = '#6b7280';
  addSys('ğŸ‘‹ ØºØ§Ø¯Ø± Ø§Ù„Ù…Ø¬Ù‡ÙˆÙ„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©');
  toast('Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©');
  show('landing');
});

/* =========================
   App state + UI
========================= */
let state='landing';
let msgCount=0;
let chatStart=null;

const peerEmojis = ['ğŸ‘¤','ğŸ­','ğŸ‘»','ğŸ¤–','ğŸ¦Š','ğŸº','ğŸ§©','ğŸŒ’','ğŸª','ğŸ•¶ï¸'];

function addSys(text){
  const d = document.createElement('div');
  d.className = 'sys';
  d.textContent = text;
  $('msgs').appendChild(d);
  $('msgs').scrollTop = $('msgs').scrollHeight;
}

function addMsg(who, text){
  const row = document.createElement('div');
  row.className = 'row ' + (who==='me'?'me':'them');
  const bubble = document.createElement('div');
  bubble.className = 'bub';
  bubble.textContent = text;
  const t = document.createElement('div');
  t.className = 'time';
  t.textContent = timeNow();

  const wrap = document.createElement('div');
  wrap.appendChild(bubble);
  wrap.appendChild(t);

  row.appendChild(wrap);
  $('msgs').appendChild(row);
  $('msgs').scrollTop = $('msgs').scrollHeight;
}

function addVoice(who, blob){
  const row = document.createElement('div');
  row.className = 'row ' + (who==='me'?'me':'them');

  const bubble = document.createElement('div');
  bubble.className = 'bub';

  const url = URL.createObjectURL(blob);
  const audio = document.createElement('audio');
  audio.controls = true;
  audio.src = url;
  audio.style.width = '240px';
  audio.style.maxWidth = '100%';

  bubble.appendChild(audio);

  const t = document.createElement('div');
  t.className = 'time';
  t.textContent = timeNow();

  const wrap = document.createElement('div');
  wrap.appendChild(bubble);
  wrap.appendChild(t);

  row.appendChild(wrap);
  $('msgs').appendChild(row);
  $('msgs').scrollTop = $('msgs').scrollHeight;
}

function connectChat(peerId){
  state='chat';
  msgCount=0; chatStart=Date.now();

  const emoji = peerEmojis[Math.floor(Math.random()*peerEmojis.length)];
  $('peerEmoji').textContent = emoji;
  $('peerId').textContent = '#'+peerId;
  $('peerStat').textContent = 'âš¡ Ù…ØªØµÙ„ Ø§Ù„Ø¢Ù†';
  $('peerDot').style.background = 'var(--g)';

  $('msgs').innerHTML = '<div class="sys">ğŸ”’ Ù…Ø­Ø§Ø¯Ø«Ø© Ø®Ø§ØµØ© Â· Ù„Ø§ Ø£Ø­Ø¯ ÙŠØ±Ø§Ù‡Ø§</div>';
  addSys('âœ… ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù…Ø¬Ù‡ÙˆÙ„ #' + peerId);

  show('chat');
  setTimeout(()=> $('input').focus(), 350);
}

/* Buttons */
$('startBtn').onclick = ()=>{
  state='matching';
  show('matching');
  $('matchSub').textContent = 'Ø¬Ø§Ø±ÙŠ Ù…Ø³Ø­ Ø§Ù„Ø´Ø¨ÙƒØ©';
  socket.emit('find:partner', {tags:getTags()});
};

$('cancelBtn').onclick = ()=>{
  state='landing';
  socket.emit('chat:end');
  show('landing');
};

$('nextBtn').onclick = ()=>{
  state='matching';
  show('matching');
  $('matchSub').textContent = 'Ù†Ø¨Ø­Ø« Ø¹Ù† Ø´Ø®Øµ Ø¬Ø¯ÙŠØ¯...';
  socket.emit('find:partner', {tags:getTags()});
};

$('endBtn').onclick = ()=>{
  socket.emit('chat:end');
  state='landing';
  show('landing');
  toast('ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©');
};

/* Text input */
const input = $('input');
input.addEventListener('input', ()=>{
  input.style.height='auto';
  input.style.height = Math.min(input.scrollHeight, 120)+'px';
  let len = input.value.length;
  if(len>500){ input.value = input.value.slice(0,500); len=500; }
  $('count').textContent = `${len} / 500`;
});

input.addEventListener('keydown', (e)=>{
  if(e.key==='Enter' && !e.shiftKey){
    e.preventDefault();
    sendText();
    return;
  }
  if(state==='chat'){
    socket.emit('typing:start');
    clearTimeout(typingTimer);
    typingTimer = setTimeout(()=> socket.emit('typing:stop'), 1200);
  }
});

$('sendBtn').onclick = sendText;

function sendText(){
  const txt = input.value.trim();
  if(!txt || state!=='chat') return;
  socket.emit('message:send', {text:txt});
  addMsg('me', txt);
  msgCount++;
  input.value='';
  input.style.height='auto';
  $('count').textContent='0 / 500';
  socket.emit('typing:stop');
}

/* =========================
   Voice Recording (WebM/Opus ØºØ§Ù„Ø¨Ø§Ù‹)
========================= */
let mediaRecorder = null;
let chunks = [];
let recording = false;

$('micBtn').onclick = async ()=>{
  if(state!=='chat') return toast('Ø§Ø¨Ø¯Ø£ Ù…Ø­Ø§Ø¯Ø«Ø© Ø£ÙˆÙ„Ø§Ù‹');

  if(!recording){
    try{
      const stream = await navigator.mediaDevices.getUserMedia({audio:true});
      chunks = [];
      mediaRecorder = new MediaRecorder(stream); // Ø§Ù„Ù…ØªØµÙØ­ ÙŠØ­Ø¯Ø¯ Ø§Ù„Ù†ÙˆØ¹
      mediaRecorder.ondataavailable = (e)=>{ if(e.data && e.data.size) chunks.push(e.data); };
      mediaRecorder.onstop = async ()=>{
        // Ø§ØºÙ„Ø§Ù‚ Ø§Ù„Ù…Ø§ÙŠÙƒ
        stream.getTracks().forEach(t=>t.stop());

        const blob = new Blob(chunks, {type: mediaRecorder.mimeType || 'audio/webm'});
        addVoice('me', blob);

        // Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø³ÙŠØ±ÙØ±: ArrayBuffer
        const buf = await blob.arrayBuffer();
        socket.emit('voice:send', {audio: buf, mime: blob.type});
        toast('ğŸ™ï¸ ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØµÙˆØª');
      };
      mediaRecorder.start();
      recording = true;
      $('micBtn').classList.add('rec');
      $('micBtn').textContent = 'â¹ï¸';
      toast('ğŸ™ï¸ Ø¨Ø¯Ø£ Ø§Ù„ØªØ³Ø¬ÙŠÙ„...');
    }catch(err){
      toast('â— ÙØ¹Ù‘Ù„ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…Ø§ÙŠÙƒ');
    }
  } else {
    // stop
    recording = false;
    $('micBtn').classList.remove('rec');
    $('micBtn').textContent = 'ğŸ™ï¸';
    try{ mediaRecorder.stop(); }catch(e){}
  }
};
</script>
</body>
</html>
